{% extends "base.html" %}

{% block title %}Relatórios - SENAI Morvan Figueiredo{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    .metric-card:hover {
        transform: translateY(-3px);
    }
    .chart-container {
        position: relative;
        height: 300px;
    }
    .export-btn {
        border-radius: 8px;
        padding: 12px 20px;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 senai-text-color">
                <i class="fas fa-chart-bar me-2"></i>
                Relatórios e Análises
            </h1>
            <p class="text-muted">Análise detalhada das aquisições e indicadores financeiros</p>
        </div>
    </div>

    <!-- Summary Metrics -->
    <div class="row g-3 mb-5">
        <div class="col-xl-4 col-md-6">
            <div class="card metric-card senai-bg text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="card-title text-uppercase mb-1">Valor Total</h5>
                            <h2 class="mb-0">R$ {{ "%.2f"|format(total_value) }}</h2>
                            <p class="mb-0 opacity-75">Todas as aquisições</p>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-3x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-4 col-md-6">
            <div class="card metric-card bg-success text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="card-title text-uppercase mb-1">Serviços</h5>
                            <h2 class="mb-0">R$ {{ "%.2f"|format(servicos_value) }}</h2>
                            <p class="mb-0 opacity-75">{{ "%.1f"|format((servicos_value / total_value * 100) if total_value > 0 else 0) }}% do total</p>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-tools fa-3x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-4 col-md-6">
            <div class="card metric-card bg-info text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="card-title text-uppercase mb-1">Insumos</h5>
                            <h2 class="mb-0">R$ {{ "%.2f"|format(insumos_value) }}</h2>
                            <p class="mb-0 opacity-75">{{ "%.1f"|format((insumos_value / total_value * 100) if total_value > 0 else 0) }}% do total</p>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-boxes fa-3x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mb-5">
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Gastos Mensais - {{ "now"|strftime('%Y') }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-building me-2"></i>
                        Gastos por Centro de Custo
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="costCenterChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Tables -->
    <div class="row mb-5">
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar me-2"></i>
                        Resumo Mensal
                    </h5>
                </div>
                <div class="card-body">
                    {% if monthly_data %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Mês</th>
                                    <th>Tipo</th>
                                    <th>Quantidade</th>
                                    <th>Valor Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for month, type, total, count in monthly_data %}
                                <tr>
                                    <td>{{ month|int }}/{{ "now"|strftime('%Y') }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if type.value == 'servico' else 'info' }}">
                                            {{ 'Serviço' if type.value == 'servico' else 'Insumo' }}
                                        </span>
                                    </td>
                                    <td>{{ count }}</td>
                                    <td class="fw-bold">R$ {{ "%.2f"|format(total) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-2">Nenhum dado mensal disponível</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-building me-2"></i>
                        Por Centro de Custo
                    </h5>
                </div>
                <div class="card-body">
                    {% if cost_center_data %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Centro de Custo</th>
                                    <th>Quantidade</th>
                                    <th>Valor Total</th>
                                    <th>%</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for name, total, count in cost_center_data %}
                                <tr>
                                    <td class="fw-bold">{{ name }}</td>
                                    <td>{{ count }}</td>
                                    <td class="fw-bold">R$ {{ "%.2f"|format(total) }}</td>
                                    <td>
                                        <span class="badge bg-secondary">
                                            {{ "%.1f"|format((total / total_value * 100) if total_value > 0 else 0) }}%
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-building text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-2">Nenhum dado de centro de custo disponível</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Export Section -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-download me-2"></i>
                        Exportar Relatórios
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="border rounded p-4 h-100">
                                <div class="text-center">
                                    <i class="fas fa-file-pdf text-danger" style="font-size: 3rem;"></i>
                                    <h5 class="mt-3 mb-2">Relatório PDF</h5>
                                    <p class="text-muted mb-3">
                                        Relatório completo em formato PDF com gráficos e análises detalhadas.
                                        Ideal para apresentações e documentação.
                                    </p>
                                    <a href="{{ url_for('export_pdf_report') }}" class="btn btn-danger export-btn">
                                        <i class="fas fa-file-pdf me-2"></i>
                                        Baixar PDF
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="border rounded p-4 h-100">
                                <div class="text-center">
                                    <i class="fas fa-file-excel text-success" style="font-size: 3rem;"></i>
                                    <h5 class="mt-3 mb-2">Planilha Excel</h5>
                                    <p class="text-muted mb-3">
                                        Dados completos em formato Excel com múltiplas abas e gráficos.
                                        Perfeito para análises detalhadas.
                                    </p>
                                    <a href="{{ url_for('export_excel_report') }}" class="btn btn-success export-btn">
                                        <i class="fas fa-file-excel me-2"></i>
                                        Baixar Excel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Informação:</strong> Os relatórios incluem todos os dados de aquisições com base nas 
                                permissões do seu perfil de usuário. Os arquivos são gerados em tempo real com os dados mais atualizados.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Monthly Chart Data
    const monthlyChartData = {
        labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
        datasets: []
    };

    // Process monthly data
    const monthlyData = {};
    {% for month, type, total, count in monthly_data %}
    const month{{ loop.index }} = {{ month|int }} - 1; // Convert to 0-based index
    const type{{ loop.index }} = '{{ type.value }}';
    const total{{ loop.index }} = {{ total }};
    
    if (!monthlyData[type{{ loop.index }}]) {
        monthlyData[type{{ loop.index }}] = new Array(12).fill(0);
    }
    monthlyData[type{{ loop.index }}][month{{ loop.index }}] = total{{ loop.index }};
    {% endfor %}

    // Add datasets for each type
    if (monthlyData['servico']) {
        monthlyChartData.datasets.push({
            label: 'Serviços',
            data: monthlyData['servico'],
            backgroundColor: 'rgba(25, 135, 84, 0.2)',
            borderColor: 'rgba(25, 135, 84, 1)',
            borderWidth: 2,
            fill: true
        });
    }

    if (monthlyData['insumo']) {
        monthlyChartData.datasets.push({
            label: 'Insumos',
            data: monthlyData['insumo'],
            backgroundColor: 'rgba(13, 202, 240, 0.2)',
            borderColor: 'rgba(13, 202, 240, 1)',
            borderWidth: 2,
            fill: true
        });
    }

    // Cost Center Chart Data
    const costCenterData = {
        labels: [
            {% for name, total, count in cost_center_data %}
            '{{ name }}'{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            data: [
                {% for name, total, count in cost_center_data %}
                {{ total }}{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            backgroundColor: [
                '#1e4a6b', '#198754', '#0dcaf0', '#ffc107', '#fd7e14', '#dc3545', '#6f42c1', '#20c997'
            ],
            borderWidth: 0
        }]
    };

    // Initialize charts
    document.addEventListener('DOMContentLoaded', function() {
        // Monthly Line Chart
        const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
        new Chart(monthlyCtx, {
            type: 'line',
            data: monthlyChartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR');
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });

        // Cost Center Doughnut Chart
        const costCenterCtx = document.getElementById('costCenterChart').getContext('2d');
        new Chart(costCenterCtx, {
            type: 'doughnut',
            data: costCenterData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return context.label + ': R$ ' + context.parsed.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}
